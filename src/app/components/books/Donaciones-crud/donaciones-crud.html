<div class="encabezado">
    <h2>Gestión de Donaciones</h2> 
</div>

<div class="encabezado-acciones">
    <div class="col-md-6">
        <reusable-search (search)="searchText($event)"></reusable-search>
    </div>
     <button class="btn-new" (click)="openNew()">
         <i class="bi bi-plus-circle me-1"></i> Nueva Donación 
     </button>
</div>

<div class="row mb-4 align-items-center">
    <div class="col-md-6 text-end">
        <span class="small" style="color:#9bb4d1;">
            Total de Donaciones: {{ donaciones.length }}
        </span>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered table-hover align-middle" style="color:#e8f1ff;">
        <thead style="background:#0d1b31; color:#37c7ff;">
            <tr>
                <th>Título</th>
                <th>Autor</th>
                <th>Año</th>
                <th>Categoría</th>
                <th>Donado por</th>
                <th>Fecha Donación</th>
                <th>Estado</th>
                <th>En Inventario</th>
                <th class="text-center">Acciones</th>
            </tr>
        </thead>

        <tbody>
            @for(donacion of donaciones; track donacion.id) {
            <tr style="background:rgba(255,255,255,0.02);">
                <td class="fw-bold">{{donacion.title}}</td>
                <td>{{donacion.author}}</td>
                <td>{{donacion.year}}</td>
                <td>
                    <span class="badge bg-info">
                        {{getCategoryName(donacion.categoryId)}}
                    </span>
                </td>
                <td>{{donacion.donatedBy}}</td>
                <td>{{donacion.donationDate | date:'dd/MM/yyyy'}}</td>
                <td>
                    @if (donacion.estado === 'Nuevo') {
                    <span class="badge bg-success">Nuevo</span>
                    } @else {
                    <span class="badge bg-warning text-dark">Usado</span>
                    }
                </td>
                <td>
                    @if (donacion.convertedToInventory) {
                    <span class="badge bg-success">Sí</span>
                    } @else {
                    <span class="badge bg-secondary">No</span>
                    }
                </td>
                <td class="text-center">
                    <div class="btn-group">
                        @if (!donacion.convertedToInventory) {
                        <button class="btn btn-sm"
                            style="border-color:#198754; color:#198754;"
                            title="Convertir a Inventario" 
                            (click)="convertToInventory(donacion)">
                            <i class="bi bi-arrow-right-circle"></i>
                        </button>
                        }

                        <button class="btn btn-sm"
                            style="border-color:#ffc107; color:#ffc107;"
                            title="Editar" 
                            (click)="openEdit(donacion)">
                            <i class="bi bi-pen"></i>
                        </button>

                        <button class="btn btn-sm"
                            style="border-color:#dc3545; color:#dc3545;"
                            title="Eliminar" 
                            (click)="delete(donacion)">
                            <i class="bi bi-trash3"></i>
                        </button>
                    </div>
                </td>
            </tr>
            }

            @empty {
            <tr>
                <td colspan="9" class="text-center py-4" style="color:#9bb4d1;">
                    <i class="bi bi-box-seam fs-4 d-block mb-2"></i>
                    No se encontraron donaciones de libros.
                </td>
            </tr>
            }
        </tbody>
    </table>
</div>

<!-- MODAL -->
<div class="modal fade" id="donacionModal" tabindex="-1" #donacionModalRef>
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background:#101f36; color:#e8f1ff;">
            <div class="modal-header" style="background:#0d1b31; color:#37c7ff;">
                <h5 class="modal-title">
                    {{ editingId ? 'Editar Donación' : 'Nueva Donación de Libro' }}
                </h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form [formGroup]="formDonacion">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Título *</label>
                            <input type="text" class="form-control"
                                style="background:#0d1b31; color:white; border:1px solid #1ab4ff;"
                                formControlName="title">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Autor *</label>
                            <input type="text" class="form-control"
                                style="background:#0d1b31; color:white; border:1px solid #1ab4ff;"
                                formControlName="author">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Año *</label>
                            <input type="number" class="form-control"
                                style="background:#0d1b31; color:white; border:1px solid #1ab4ff;"
                                formControlName="year"
                                [min]="1000"
                                [max]="currentYear"> <!-- Cambiado a currentYear -->
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Categoría *</label>
                            <select class="form-select"
                                style="background:#0d1b31; color:white; border:1px solid #1ab4ff;"
                                formControlName="categoryId">
                                <option value="" disabled>Seleccione una categoría</option>
                                @for(categoria of categorias; track categoria.id) {
                                <option [value]="categoria.id">{{categoria.name}}</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Donado por *</label>
                            <input type="text" class="form-control"
                                style="background:#0d1b31; color:white; border:1px solid #1ab4ff;"
                                formControlName="donatedBy"
                                placeholder="Nombre del donante">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Fecha de Donación *</label>
                            <input type="date" class="form-control"
                                style="background:#0d1b31; color:white; border:1px solid #1ab4ff;"
                                formControlName="donationDate"
                                [max]="getCurrentDate()"> <!-- Para que no seleccione fecha futura -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Estado del Libro *</label>
                        <select class="form-select"
                            style="background:#0d1b31; color:white; border:1px solid #1ab4ff;"
                            formControlName="estado">
                            <option value="Nuevo">Nuevo</option>
                            <option value="Usado">Usado</option>
                            <option value="Excelente">Excelente</option>
                            <option value="Bueno">Bueno</option>
                            <option value="Regular">Regular</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        style="background:#6c757d;"
                        data-bs-dismiss="modal">
                        Cancelar
                    </button>

                    <button class="btn"
                        style="background:#1ab4ff; color:white;"
                        type="button"
                        (click)="save()"
                        [disabled]="formDonacion.invalid">
                        <i class="bi bi-save me-1"></i> 
                        {{ editingId ? 'Actualizar' : 'Guardar' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
